name: Semantic Audit

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  audit:
    name: Semantic Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Perception Node (Identify Changed Files)
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/*.py
            **/*.js
            **/*.md

      - name: Setup Python
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          pip install -r requirements.txt

      - name: Reasoning Layer (Run Integrity Agent)
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: ./ # Uses the action.yml in the root
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          code_file: ${{ steps.changed-files.outputs.all_changed_files }}
          doc_file: 'README.md'
          fail_on_drift: 'true'

      - name: Gatekeeper Action (Post Audit Report)
        if: always() && steps.changed-files.outputs.any_changed == 'true'
        run: echo "Audit Complete. Reports are posted directly to the PR by the agent."
        with:
          header: semantic-audit
          path: audit_report.md
